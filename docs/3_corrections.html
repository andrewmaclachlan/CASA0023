<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>CASA0023 Remotely Sensing Cities and Environments - 3&nbsp; Corrections</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./4_policy.html" rel="next">
<link href="./2_portfolio.html" rel="prev">
<link href="./assets/favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-5LZK055F2X"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-5LZK055F2X', { 'anonymize_ip': true});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>
</head>
<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg navbar-dark "><div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    <img src="./general_images/casa_logo.jpg" alt="" class="navbar-logo"></a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">CASA0023 Remotely Sensing Cities and Environments</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
<li class="nav-item compact">
    <a class="nav-link" href="https://github.com/andrewmaclachlan/CASA0023"><i class="bi bi-github" role="img" aria-label="Source Code">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
<div class="quarto-toggle-container">
                  <a href="" class="quarto-color-scheme-toggle nav-link" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
                  <a href="" class="quarto-reader-toggle nav-link" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
              </div>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">
<span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Corrections</span>
</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto"><div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Welcome</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./00-course_info.html" class="sidebar-item-text sidebar-link">Hello Remote Sensing</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./intro.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Getting started with remote sensing</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./2_portfolio.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Portfolio</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./3_corrections.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Corrections</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./4_policy.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Policy</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./5_GEE_I.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Google Earth Engine I</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./6_classification_I.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Classification I</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./7_classification_II.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Classification II</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./8_temperature.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Temperature</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./9_SAR.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">SAR</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./resources.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Resources</span></a>
  </div>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#resources" id="toc-resources" class="nav-link active" data-scroll-target="#resources"><span class="toc-section-number">3.1</span>  Resources</a></li>
  <li>
<a href="#atmosphereic-correction" id="toc-atmosphereic-correction" class="nav-link" data-scroll-target="#atmosphereic-correction"><span class="toc-section-number">3.2</span>  Atmosphereic correction</a>
  <ul class="collapse">
<li><a href="#dos" id="toc-dos" class="nav-link" data-scroll-target="#dos"><span class="toc-section-number">3.2.1</span>  DOS</a></li>
  <li><a href="#radiance-or-dn-to-reflectance" id="toc-radiance-or-dn-to-reflectance" class="nav-link" data-scroll-target="#radiance-or-dn-to-reflectance"><span class="toc-section-number">3.2.2</span>  Radiance (or DN) to Reflectance</a></li>
  </ul>
</li>
  <li><a href="#accessing-data" id="toc-accessing-data" class="nav-link" data-scroll-target="#accessing-data"><span class="toc-section-number">3.3</span>  Accessing data</a></li>
  <li><a href="#merging-imagery" id="toc-merging-imagery" class="nav-link" data-scroll-target="#merging-imagery"><span class="toc-section-number">3.4</span>  Merging imagery</a></li>
  <li>
<a href="#enhancements" id="toc-enhancements" class="nav-link" data-scroll-target="#enhancements"><span class="toc-section-number">3.5</span>  Enhancements</a>
  <ul class="collapse">
<li><a href="#ratio" id="toc-ratio" class="nav-link" data-scroll-target="#ratio"><span class="toc-section-number">3.5.1</span>  Ratio</a></li>
  <li><a href="#filtering" id="toc-filtering" class="nav-link" data-scroll-target="#filtering"><span class="toc-section-number">3.5.2</span>  Filtering</a></li>
  <li><a href="#texture" id="toc-texture" class="nav-link" data-scroll-target="#texture"><span class="toc-section-number">3.5.3</span>  Texture</a></li>
  <li><a href="#data-fusion" id="toc-data-fusion" class="nav-link" data-scroll-target="#data-fusion"><span class="toc-section-number">3.5.4</span>  Data fusion</a></li>
  <li><a href="#pca" id="toc-pca" class="nav-link" data-scroll-target="#pca"><span class="toc-section-number">3.5.5</span>  PCA</a></li>
  </ul>
</li>
  <li>
<a href="#learning-diary" id="toc-learning-diary" class="nav-link" data-scroll-target="#learning-diary"><span class="toc-section-number">3.6</span>  Learning diary</a>
  <ul class="collapse">
<li><a href="#useful-blogs" id="toc-useful-blogs" class="nav-link" data-scroll-target="#useful-blogs"><span class="toc-section-number">3.6.1</span>  Useful blogs</a></li>
  </ul>
</li>
  <li><a href="#feedback" id="toc-feedback" class="nav-link" data-scroll-target="#feedback"><span class="toc-section-number">3.7</span>  Feedback</a></li>
  </ul><div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/andrewmaclachlan/CASA0023/edit/main/3_corrections.qmd" class="toc-action">Edit this page</a></p><p><a href="https://github.com/andrewmaclachlan/CASA0023/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title d-none d-lg-block">
<span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Corrections</span>
</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><section id="resources" class="level2" data-number="3.1"><h2 data-number="3.1" class="anchored" data-anchor-id="resources">
<span class="header-section-number">3.1</span> Resources</h2>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
This week
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li><p>Joyce, K., 2013. <a href="https://www.youtube.com/watch?v=qb4yFwzsnU8&amp;t">Radiative transfer and atmospheric correction video</a></p></li>
<li>
<p>Jensen, J.R., 2015. <a href="https://read.kortext.com/reader/pdf/1872407/Cover">Introductory digital image processing: a remote sensing perspective.</a> Prentice-Hall Inc.</p>
<ul>
<li><p>Atmospheric correction, Chapter 6, p.208</p></li>
<li><p>Types of Geometric correction, Chapter 7, p.242</p></li>
<li><p>Mosaicking, Chapter 7, p.267</p></li>
<li><p>Image enhancements, Chapter 8, p.273</p></li>
</ul>
</li>
<li>
<p>Schulte to Bühne, H., Pettorelli, N., 2018. <a href="https://doi.org/10.1111/2041-210X.12942">Better together: Integrating and fusing multispectral and radar satellite imagery to inform biodiversity monitoring, ecological research and conservation science. Methods in Ecology and Evolution 9, 849–865.</a></p>
<ul>
<li>
<a href="https://www.youtube.com/watch?v=a4dW5EWbNK4&amp;t=3s">Data fusion video</a> created for the paper</li>
</ul>
</li>
</ul>
</div>
</div>
</section><section id="atmosphereic-correction" class="level2" data-number="3.2"><h2 data-number="3.2" class="anchored" data-anchor-id="atmosphereic-correction">
<span class="header-section-number">3.2</span> Atmosphereic correction</h2>
<section id="dos" class="level3" data-number="3.2.1"><h3 data-number="3.2.1" class="anchored" data-anchor-id="dos">
<span class="header-section-number">3.2.1</span> DOS</h3>
<p>As described in the lecture, a rather simple method to correct raw satellite (or any other) imagery is called Dark Object Subtraction (DOS). This uses the logic that the darkest pixel within the image should be 0 and therefore any value that it has can be attributed to the atmosphere.</p>
<p>So in order to remove the effect of the atmosphere we can the subtract the value from the rest of the pixels within the image.</p>
<p>Here, we will need to download some raw satellite imagery, that is in Digital Number (DN).</p>
<p>Then we will apply the formula to calculate the reluctance of the pixels by removing atmosphere effects.The formula for the cosine of the solar zenith angle correction (COST) is, this is the same as DOS but DOS omits <code>TAUz</code>. The following has made use of the <a href="https://www.gisagmaps.com/landsat-8-atco-guide/">documentation from GIS Ag Maps.com</a></p>
<p><span class="math display">\[\rho_{\lambda}= \frac{(Lsat_{rad} - Lhaze1percent_{rad})\pi * d^2}{EO_{\lambda} * cos\theta S * TUAv + TAUz}\]</span></p>
<p>Where…</p>
<ul>
<li>
<span class="math inline">\(\rho_{\lambda}\)</span> is the corrected value (DOS applied)</li>
</ul>
<p>Top line of equation…</p>
<ul>
<li><p><span class="math inline">\(Lsat_{rad}\)</span> = at sensor radiance (recall DN goes to radiance through the regression equation we saw!)</p></li>
<li>
<p><span class="math inline">\(Lhaze1percent_{rad}\)</span> = amount of radiance that is due to the atmosphere (atmospheric haze) from path or scatter radiance. Very few surfaces are completely black so it is assume that the darkest surface has a 1% reflectance. Various methods to caclcualte this…</p>
<ul>
<li>Look up tables</li>
<li>Selecting the darkest pixels (shadow, water)</li>
</ul>
</li>
</ul>
<p>When we have the haze amount then deduct 1% from that value per band as few targets are absolutely black.</p>
<p>For COST this this:</p>
<p><span class="math display">\[ 0.01 reflectance = 0.01 *\frac{Eoλ * cosθs^2} {d² * pi}\]</span></p>
<p>For DOS it’s</p>
<p><span class="math display">\[ 0.01 reflectance = 0.01 *\frac{Eoλ * cosθs} {d² * pi}\]</span></p>
<ul>
<li>
<p><span class="math inline">\(EO_{\lambda}\)</span> or <span class="math inline">\(ESUN_{\lambda}\)</span> = mean exoatmospheric irradiance</p>
<ul>
<li>irradiance = power per unit area received from the Sun</li>
<li>exoatmospheric = just outside the Earth’s atmosphere</li>
<li>These values are available from the Landsat user manual such as <a href="https://d9-wret.s3.us-west-2.amazonaws.com/assets/palladium/production/s3fs-public/atoms/files/LSDS-1927_L7_Data_Users_Handbook-v2.pdf">table 5.3 in the Landsat 7 user guide</a>
</li>
</ul>
</li>
<li><p><span class="math inline">\(cosθs\)</span> = cosine of the solar azimuth, remember from the lecture that this is 90 - solar elevation.</p></li>
<li><p><span class="math inline">\(d\)</span> = the Earth-sun distance and is in the <code>.MTL</code> file</p></li>
<li><p><span class="math inline">\(pi\)</span> = 3.14159265</p></li>
</ul>
<p>Once we have all these values then we can do the following:</p>
<ul>
<li>Compute the haze value for each band (although not beyond NIR) - this is the amount of radiance that is due to the atmosphere (atmospheric haze), see above methods.</li>
<li>Convert DN to radiance</li>
<li>Compute the 1% reflectance value using the equations above</li>
<li>Subtract the 1% reflectance value from the radiance. Here we are saying that we have a pixel (e.g.&nbsp;darkest pixel), we know what 1% of the total radiance is and we are subtracting that from the darkest pixel (which still has atmospheric effects) to account for most targets not being completely black.</li>
</ul>
<p>We can now plug the values in:</p>
<p><span class="math display">\[\rho_{\lambda}= \frac{(Lsat_{rad} - Lhaze1percent_{rad})\pi * d^2}{EO_{\lambda} * cos\theta S * TUAv + TAUz}\]</span></p>
<p>Where the <span class="math inline">\(Lhaze1percent_{rad}\)</span> is the haze value (e.g.&nbsp;darkest pixel) <strong>minus</strong> 1% of the total radiance. This 1% was computed from the equations above.</p>
<p>Within this equation:</p>
<p><span class="math inline">\(TAUv\)</span> = 1.0 for Landsat and <span class="math inline">\(TAUz\)</span> = cosθs for COST method. DOS is the same, but without <span class="math inline">\(TAUz\)</span></p>
<p>Of course we can do this in R (or any other software) with just one function! First we need to download some raw satellite data that comes in the Digital Number (DN) format. This is the exact same process as we saw in week 1, expect this time select the Collection 1 (or 2), Level-1 bundle. At the moment this process won’t work with Landsat 9. However, as this involves a large amount of data and it’s unlikely you will need to do this in the module of data read through the following code and then move to the next section</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/terra/">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster">raster</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://bleutner.github.io/RStoolbox/">RStoolbox</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://fs.r-lib.org">fs</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://rgdal.r-forge.r-project.org">rgdal</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Import meta-data and bands based on MTL file</span></span>
<span><span class="va">mtlFile</span>  <span class="op">&lt;-</span> <span class="op">(</span><span class="st">"prac_3/Lsatdata8/LC08_L1TP_175083_20211005_20211013_01_T1_MTL.txt"</span><span class="op">)</span></span>
<span>                        </span>
<span><span class="va">metaData</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RStoolbox/man/readMeta.html">readMeta</a></span><span class="op">(</span><span class="va">mtlFile</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lsatMeta</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RStoolbox/man/stackMeta.html">stackMeta</a></span><span class="op">(</span><span class="va">metaData</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># surface reflectance with DOS</span></span>
<span></span>
<span><span class="va">l8_boa_ref</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RStoolbox/man/radCor.html">radCor</a></span><span class="op">(</span><span class="va">lsatMeta</span>, <span class="va">metaData</span>, method <span class="op">=</span> <span class="st">"dos"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#terra::writeRaster(l8_boa_ref, datatype="FLT4S", filename = "prac_3/Lsatdata8/l8_boa_ref.tif", format = "GTiff", overwrite=TRUE)</span></span>
<span></span>
<span><span class="co"># Radiance </span></span>
<span></span>
<span><span class="va">lsat_rad</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RStoolbox/man/radCor.html">radCor</a></span><span class="op">(</span><span class="va">lsatMeta</span>, metaData <span class="op">=</span> <span class="va">metaData</span>, method <span class="op">=</span> <span class="st">"rad"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#terra::writeRaster(lsat_rad, datatype="FLT4S", filename = "prac_3/Lsatdata8/lsat_rad.tif", format = "GTiff", overwrite=TRUE)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">hazeDN</span>    <span class="op">&lt;-</span> <span class="fu">RStoolbox</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/RStoolbox/man/estimateHaze.html">estimateHaze</a></span><span class="op">(</span><span class="va">lsat</span>, hazeBands <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">4</span>, darkProp <span class="op">=</span> <span class="fl">0.01</span>, plot <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lsat_sref</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RStoolbox/man/radCor.html">radCor</a></span><span class="op">(</span><span class="va">lsatMeta</span>, metaData <span class="op">=</span> <span class="va">metaData</span>, method <span class="op">=</span> <span class="st">"dos"</span>, </span>
<span>                    hazeValues <span class="op">=</span> <span class="va">hazeDN</span>, hazeBands <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>https://rpubs.com/delViento/atm_corr</p>
</section><section id="radiance-or-dn-to-reflectance" class="level3" data-number="3.2.2"><h3 data-number="3.2.2" class="anchored" data-anchor-id="radiance-or-dn-to-reflectance">
<span class="header-section-number">3.2.2</span> Radiance (or DN) to Reflectance</h3>
<p>As noted in the lecture there are a wide range of more sophisticated methods (beyond Dark Object Subtraction) to convert raw Digital Numbers or radiance to surface reflectance.</p>
<p>Whilst this is a bit beyond the scope of this module, if you look again at the <a href="https://d9-wret.s3.us-west-2.amazonaws.com/assets/palladium/production/s3fs-public/atoms/files/LSDS-1927_L7_Data_Users_Handbook-v2.pdf">Landsat 7 Data Users Handbook</a> you will see a radiance to <strong>reflectance</strong> calculation that can be used…<strong>“For relatively clear Landsat scenes”</strong>:</p>
<p><span class="math display">\[\rho_{\rho}= \frac{\pi* L_{\lambda} * d ^2}{ESUN_{\lambda} * cos\theta_S}\]</span> and…we’ve seen all these values in the DOS formula, except <span class="math inline">\(\rho_{\rho}\)</span> which is Unitless planetary reflectance</p>
<p>…this method is still used in current research too, for example it’s listed in this paper of Land Surface Temperature retrieval by <a href="https://www.mdpi.com/2072-4292/12/2/294">Sekertekin and Bonafonu, 2020</a>. See Appendix C for Landsat 5, 7 (that use the above equation) and Landsat 8, that uses this slight variation…</p>
<p><span class="math display">\[\rho_{\rho}= \frac{M_{p}* Q_{CAL} + A_p}{sin\theta_{SE}}\]</span> Where…</p>
<ul>
<li><p><span class="math inline">\(M_p\)</span> is the band-specific multiplicative rescaling factor from the metadata</p></li>
<li><p><span class="math inline">\(A_p\)</span> is the band-specific additive rescaling factor from the metadata</p></li>
<li><p><span class="math inline">\(QCAL\)</span> is the digital number</p></li>
<li><p><span class="math inline">\(\theta_{SE}\)</span> is the sun elevation angle from the metadata file.</p></li>
</ul>
<p><strong>Although</strong> it’s worth noting that this is Top of Atmosphere reflectance (TOA).</p>
<p>Radiance is how much light the sensor sees.</p>
<p>Reflectance is the ratio of light leaving the target to amount striking the target. Here will still have atmopsheric effects in the way of our true <strong>apparent</strong> reflectance. Confusingly all of these can be termed reflectance and indeed sometimes radiance is referred to as reflectance.</p>
<p>TOA reflectance changes the data from what the sensor sees to the ratio of light leaving compared to striking it. BUT, the atmosphere is still present. If we remove the atmopshere we have apparent reflectance (sometimes called Bottom of Atmosphere reflectance). DOS gives us a <strong>version</strong> of apparent reflectance.</p>
</section></section><section id="accessing-data" class="level2" data-number="3.3"><h2 data-number="3.3" class="anchored" data-anchor-id="accessing-data">
<span class="header-section-number">3.3</span> Accessing data</h2>
<p>Ok, so we can deal with a single image, but what happens when an image doesn’t cover your entire study area. We must select two images are mosaic (or merge) them together. Landsat data (and most satellite data) is collected using some form of Worldwide Reference System. This splits the data based on PATH (columns) and ROWS.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="prac_3/path_row.png" class="img-fluid figure-img" style="width:100.0%"></p>
<p></p><figcaption class="figure-caption">Source: <a href="https://www.researchgate.net/publication/340870377_LANDSAT_PATH_AND_ROW_-_NIGERIA">Samuel Akande</a></figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Before we start with merging we need to download two satellite tiles to merge together. The problem is that Landsat tiles won’t align with administration boundraies (or they might if you are lucky). For my example city of Cape Town i need at least two, possible three Landsat tiles to be merged together. In USGS Earth Explorer you can upload a shapefile or KML so you can search for tiles to cover the area. However, this is rather slow and the shapefile must only contain <strong>one</strong> polygon (cape town includes an island too). You can, however, draw a boundary to search within:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="prac_3/landsat_search.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>In my example i am going to select two tiles, i know which two to select from looking at the <a href="https://gadm.org/">GADM</a> boundary for Cape Town.</p>
<p>When doing this:</p>
<ul>
<li>Select two images as temporally close to each other as possible</li>
<li>Try and make sure there is no (or very little cloud cover)</li>
<li>In this case select Landsat Collection 2 level 2 to get surface reflectance.</li>
</ul>
<p>Notes on Landsat Collections. The different collections denote a major difference in processing of the data. Where as the levels denote a specific product. There is no clear guide online that explains this, so be careful when reading papers!</p>
<p>For example…</p>
<blockquote class="blockquote">
<p>A primary characteristic of Collection 2 is the substantial improvement in the absolute geolocation accuracy of the global ground reference dataset used in the Landsat Level-1 processing flow</p>
</blockquote>
<p>Collection 2 was released in 2020 and has some updates, see <a href="https://d9-wret.s3.us-west-2.amazonaws.com/assets/palladium/production/s3fs-public/atoms/files/Landsat-C1vsC2-2021-0430-LMWS.pdf">this summary of differences for collection 1 vs collection 2</a>. The collection 2 auxiliary data can also be downloaded from Earth Explorer.</p>
<p>Whereas levels will provide:</p>
<ul>
<li><p>Level 1 is delivered as a <a href="https://www.usgs.gov/landsat-missions/landsat-collection-2-level-1-data">Digital Number</a></p></li>
<li><p>Level 2 includes surface reflectance and surface temperature</p></li>
<li><p>Level 3 science products are specific products generated from the data such as Burned Area, surface water extent</p></li>
<li><p>Most of the level datasets are tiered, this is denoted through the file name that might end with T1. Tiers are based on data quality and level of processing. Tier 1 datasets are the best quality, tier 2 are good but might have some cloud that affects radiometric calibration covering ground control points.<br>
There is also a U.S. Analysis Read Dataset (ARD) that includes a bundle of data (Top of Atmosphere (TOA) reflectance, TOA Brightness Temperature, Surface Reflectance , Surface Temperature and Quality Assessment) in a specific US grid strucutre. This removes the need to process data between the difference stages for applications in the US.</p></li>
</ul>
<p>To conclude, we have collections, followed by levels, followed by tiers.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="prac_3/Landsat-Science-Products-Infotable.jfif" class="img-fluid figure-img" style="width:100.0%"></p>
<p></p><figcaption class="figure-caption">Source: <a href="https://www.usgs.gov/media/images/landsat-level-2-and-level-3-science-products">USGS</a></figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>In this case I want to download two tiles from Collection 2, Level 2. You can view the tiles and preview the data in Earth Explorer:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="prac_3/landsat_tiles.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
<p>Looking at the options below each tile icon in the search results you can either download the tiles individually or add them to a basked (it’s the box icon). After clicking the box on the products you want to download &gt; click the basket (top right) &gt; you will then be presented with this screen where you click start order and then follow the prompts to download multiple tiles at once.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="prac_3/start_order.png" class="img-fluid figure-img" style="width:100.0%"></p>
</figure>
</div>
</div>
</div>
</section><section id="merging-imagery" class="level2" data-number="3.4"><h2 data-number="3.4" class="anchored" data-anchor-id="merging-imagery">
<span class="header-section-number">3.4</span> Merging imagery</h2>
<p>Open our two tiles, in my case i have move my tiles into two separate folders. So i will do this twice, note that we could automate this if we had a large number of tiles. I have also downloaded one Landsat 8 tile and one Landsat 9 tile.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/terra/">terra</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://fs.r-lib.org">fs</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># List your raster files excluding band 8 using the patter argument</span></span>
<span><span class="va">listlandsat_8</span><span class="op">&lt;-</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html">dir_info</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"prac_3"</span>, <span class="st">"Landsat"</span>, <span class="st">"Lsat8"</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"[B123456790].TIF"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Load our raster layers into a stack</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For Landsat 9</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># List your raster files excluding band 8 using the patter argument</span></span>
<span><span class="va">listlandsat_9</span><span class="op">&lt;-</span><span class="fu"><a href="https://fs.r-lib.org/reference/dir_ls.html">dir_info</a></span><span class="op">(</span><span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"prac_3"</span>, <span class="st">"Landsat"</span>, <span class="st">"Lsat9"</span><span class="op">)</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"[1B23456790].TIF"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="op">)</span><span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co"># Load our raster layers into a stack</span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This might take about 2 minutes…</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/mosaic.html">mosaic</a></span><span class="op">(</span><span class="va">listlandsat_8</span>, <span class="va">listlandsat_9</span>, fun<span class="op">=</span><span class="st">"mean"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="enhancements" class="level2" data-number="3.5"><h2 data-number="3.5" class="anchored" data-anchor-id="enhancements">
<span class="header-section-number">3.5</span> Enhancements</h2>
<p>Using our merged Landsat data we can now undertake some basic enhancements to try and emphasize / exaggerate certain features or spectral traits.</p>
<section id="ratio" class="level3" data-number="3.5.1"><h3 data-number="3.5.1" class="anchored" data-anchor-id="ratio">
<span class="header-section-number">3.5.1</span> Ratio</h3>
<p>Ratioing is the difference between two spectral bands that have a certain spectral response meaning it is easier to identify a certain landscape feature…for example…</p>
<ul>
<li>The Normalised Difference Vegetation Index is based on the fact that healthy and green vegetation reflects more in the NIR but absorbs in the Red wavelength</li>
</ul>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="prac_3/leaf.jpg" class="img-fluid figure-img" style="width:70.0%"></p>
<p></p><figcaption class="figure-caption">Source: <a href="https://physicsopenlab.org/2017/01/30/ndvi-index/">PhysicsOpenLab</a></figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Here, we can visually see the spectral trait:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="prac_3/NDVI.png" class="img-fluid figure-img" style="width:70.0%"></p>
<p></p><figcaption class="figure-caption">Source: <a href="https://physicsopenlab.org/2017/01/30/ndvi-index/">PhysicsOpenLab</a></figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>We can leverage the fact that healthy vegetation has this spectral trait and use the NDVI index should we wish to highlight areas with healthy vegetation.</p>
<p><span class="math display">\[NDVI= \frac{NIR-Red}{NIR+Red}\]</span> In R this would be:</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m1_NDVI</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">m1</span><span class="op">$</span><span class="va">LC08_L2SP_175083_20220501_20220504_02_T1_SR_B5</span> <span class="op">-</span> <span class="va">m1</span><span class="op">$</span><span class="va">LC08_L2SP_175083_20220501_20220504_02_T1_SR_B4</span> <span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">m1</span><span class="op">$</span><span class="va">LC08_L2SP_175083_20220501_20220504_02_T1_SR_B5</span> <span class="op">+</span> <span class="va">m1</span><span class="op">$</span><span class="va">LC08_L2SP_175083_20220501_20220504_02_T1_SR_B4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m1_NDVI</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can reclassify this to pull out certain areas, for example, only where NDVI is equal to or greater than 0.2</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">veg</span> <span class="op">&lt;-</span> <span class="va">m1_NDVI</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/classify.html">classify</a></span><span class="op">(</span><span class="va">.</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="fl">0.2</span>, <span class="cn">NA</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">veg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="3_corrections_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>There are many other ratios, all of which are detailed on the <a href="https://www.indexdatabase.de/">Index Database</a> and most follow the same formula. For example, the Normalized Difference Moisture Index (NDMI):</p>
<p>For Landsat sensors 4-7:</p>
<p><span class="math display">\[NDMI= \frac{Band 4-Band 5}{Band 4 + Band 5}\]</span> For Landsat 8, bands are increased by 1.</p>
</section><section id="filtering" class="level3" data-number="3.5.2"><h3 data-number="3.5.2" class="anchored" data-anchor-id="filtering">
<span class="header-section-number">3.5.2</span> Filtering</h3>
<p>Filtering refers to any kind of moving window operation to our data which can be saved as a separate raster file. As we saw in the lecture this can include low or high pass filters. Here <span class="math inline">\(w\)</span> means window. We can also set a weight matrix (as seen in the lecture):</p>
<p><a href="https://cran.r-project.org/web/packages/terra/terra.pdf"><code>Laplacian filter: matrix(c(0,1,0,1,-4,1,0,1,0), nrow=3)</code></a></p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="prac_3/focalmean.gif" class="img-fluid figure-img" style="width:70.0%"></p>
<p></p><figcaption class="figure-caption">Source: <a href="http://courses.washington.edu/gis250/lessons/raster_analysis1/index.html">Introduction to Geographic Information Systems in Forest Resources</a></figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># for a 3 by 3 filter on 1 band</span></span>
<span><span class="va">m1_filter</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/focal.html">focal</a></span><span class="op">(</span><span class="va">m1</span><span class="op">$</span><span class="va">LC08_L2SP_175083_20220501_20220504_02_T1_SR_B4</span>, w<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>nrow<span class="op">=</span><span class="fl">3</span>,ncol<span class="op">=</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="texture" class="level3" data-number="3.5.3"><h3 data-number="3.5.3" class="anchored" data-anchor-id="texture">
<span class="header-section-number">3.5.3</span> Texture</h3>
<p>The basics of texture were covered in the lecture. To apply texture analysis to data in R, we can use the <code>glcm</code> package which has a selection of eight texture measures, and we can apply these per band…for example…Note, to use this you must have <a href="https://cran.r-project.org/bin/windows/Rtools/"><code>RTools</code> installed</a> as it makes use of the C++ language.</p>
<p>Below we can specify:</p>
<ul>
<li>the size of the moving window</li>
<li>the shift for co-occurrency (or second order) as seen in the lecture. If multiple shifts are supplied, glcm will calculate each texture statistic using all the specified shifts and return the mean value of the texture for each pixel</li>
<li>the measures we want, for full equations see <a href="https://www.l3harrisgeospatial.com/docs/backgroundtexturemetrics.html#:~:text=Process%20for%20Computing%20Texture%20Metrics,-A%20moving%20window&amp;text=ENVI%20computes%20a%20histogram%20that,array%20of%20the%20occurrence%20values.&amp;text=It%20normalizes%20the%20occurrence%20values">Texture Metrics Background</a>
</li>
</ul>
<p>Note, that we commonly don’t use the pancrhomatic band in landcover classification, however as it is 15m it can produce some useful outputs.</p>
<p>Currently the <code>glcm</code> package only accepts raster layers from the <code>raster</code> package so we first need to convert this to a raster layer…this will take 7-10 minutes…increasing the window size and selecting less statistics should speed this up.</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.azvoleff.com/glcm">glcm</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster">raster</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">band4_raster</span><span class="op">&lt;-</span><span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span><span class="op">(</span><span class="va">m1</span><span class="op">$</span><span class="va">LC08_L2SP_175083_20220501_20220504_02_T1_SR_B4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">glcm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/glcm/man/glcm.html">glcm</a></span><span class="op">(</span><span class="va">band4_raster</span>,</span>
<span>                   window <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">7</span><span class="op">)</span>,</span>
<span>                   <span class="co">#shift=list(c(0,1), c(1,1), c(1,0), c(1,-1)), </span></span>
<span>                   statistics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"homogeneity"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">glcm</span><span class="op">$</span><span class="va">glcm_homogeneity</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Depending on your study area the texture measures might not show much, but in this example from <a href="https://www.scielo.br/j/pab/a/xzLvPmRfZ7nmTWCNP9t5yMf/?format=pdf&amp;lang=en">Lu et al.&nbsp;2012</a> what does it highlight or make more prominent.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="prac_3/texture_example.png" class="img-fluid figure-img" style="width:100.0%"></p>
<p></p><figcaption class="figure-caption">Source: <a href="https://www.scielo.br/j/pab/a/xzLvPmRfZ7nmTWCNP9t5yMf/?format=pdf&amp;lang=en">Land use/cover classification in the Brazilian Amazon using satellite images</a></figcaption><p></p>
</figure>
</div>
</div>
</div>
</section><section id="data-fusion" class="level3" data-number="3.5.4"><h3 data-number="3.5.4" class="anchored" data-anchor-id="data-fusion">
<span class="header-section-number">3.5.4</span> Data fusion</h3>
<p>In the simplest form data fusion is appending new raster data to the existing data or making a new raster dataset with different bands…here we can do this with the texture measure we have created (and the original spectral data if you wish). We are getting to the stage now where remote sensing is a merge of science and art. Specifically the science is how we correct and apply methods, the art is about how we select the right data / transform it / alter it to produce an output. There is never a <strong>completely right</strong> answer as we will see in future practicals.</p>
<p>To create decision level (or layer) fusion we append our new datasets to our existing data…</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># for the next step of PCA we need to keep this in a raster (and not terra) format...</span></span>
<span><span class="va">m1_raster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html">stack</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Fuse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html">stack</a></span><span class="op">(</span><span class="va">m1_raster</span>, <span class="va">glcm.red</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Recall from the lecture there is also object fusion and image fusion.</p>
</section><section id="pca" class="level3" data-number="3.5.5"><h3 data-number="3.5.5" class="anchored" data-anchor-id="pca">
<span class="header-section-number">3.5.5</span> PCA</h3>
<p>Principal Component Analysis is designed to reduce the dimensionality of our data. In this case we might want to scale our data, meaning that we can compare data that isn’t measured in the same way (as we have spectral and texture data). To do so we can use the function scale, that by default standarize the data by subtracting the mean and dividing by the standard deviation. If we just wanted to subtract the mean we could set <code>scale=FALSE</code> as an argument.</p>
<p>When we use <code><a href="https://rdrr.io/pkg/RStoolbox/man/rasterPCA.html">rasterPCA()</a></code> we can set the number of samples <code>nsamples</code> to be used for PCA which are then applied to the rest of the data to try and make this more efficient…</p>
<p>Also note that <code>spca=TRUE</code> which corresponds to centered and scaled input data</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://bleutner.github.io/RStoolbox/">RStoolbox</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">Fuse_3_bands</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html">stack</a></span><span class="op">(</span><span class="va">Fuse</span><span class="op">$</span><span class="va">LC08_L2SP_175083_20220501_20220504_02_T1_SR_B4</span>, <span class="va">Fuse</span><span class="op">$</span><span class="va">LC08_L2SP_175083_20220501_20220504_02_T1_SR_B5</span>, <span class="va">Fuse</span><span class="op">$</span><span class="va">glcm_homogeneity</span><span class="op">)</span></span>
<span></span>
<span><span class="va">scale_fuse</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">Fuse_3_bands</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pca</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/RStoolbox/man/rasterPCA.html">rasterPCA</a></span><span class="op">(</span><span class="va">Fuse</span>, </span>
<span>                 nSamples <span class="op">=</span><span class="fl">100</span>,</span>
<span>                 spca <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once the <code><a href="https://rdrr.io/pkg/RStoolbox/man/rasterPCA.html">rasterPCA()</a></code> has completed run the following code to get the proportion of variance explained by each PCA component and the cumulative proportion of the variance explained (from all the PCA layers compared to the original input data). Remember that PCA is trying to:</p>
<ul>
<li>Transform multi-spectral data into uncorrelated and smaller dataset</li>
<li>Keep most of the original information</li>
<li>The first component will (should) capture most of the variance within the dataset</li>
</ul>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/summary.html">summary</a></span><span class="op">(</span><span class="va">pca</span><span class="op">$</span><span class="va">model</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In my case component 1 (of 10) explains 77.62% of the variance from the entire dataset…how might this be useful in future analysis?</p>
<p>Finally, to plot one of the PCA bands….</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">pca</span><span class="op">$</span><span class="va">map</span><span class="op">$</span><span class="va">PC1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section></section><section id="learning-diary" class="level2" data-number="3.6"><h2 data-number="3.6" class="anchored" data-anchor-id="learning-diary">
<span class="header-section-number">3.6</span> Learning diary</h2>
<p>Consult the assignment requirements document and complete your learning diary entry in your Quarto learning diary.</p>
<section id="useful-blogs" class="level3" data-number="3.6.1"><h3 data-number="3.6.1" class="anchored" data-anchor-id="useful-blogs">
<span class="header-section-number">3.6.1</span> Useful blogs</h3>
<ul>
<li><a href="https://zia207.github.io/geospatial-r-github.io/texture-analysis.html">Texture and PCA in R</a></li>
</ul></section></section><section id="feedback" class="level2" data-number="3.7"><h2 data-number="3.7" class="anchored" data-anchor-id="feedback">
<span class="header-section-number">3.7</span> Feedback</h2>
<p>Was anything that we explained unclear this week or was something really clear…let us know using the <a href="https://forms.gle/ArGHKA2sSmN29pVLA">feedback form</a>. It’s anonymous and we’ll use the responses to clear any issues up in the future / adapt the material.</p>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./2_portfolio.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Portfolio</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./4_policy.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Policy</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>